# MIPS，你好

## 课下

### 关于MIPS

在互联网上到处都能找到MIPS相关的教程，虽各自良莠不齐，却足以各同志应付考试。因此我们在此若是长篇累牍再去论述MIPS的语法，那就真走了邪路了。在此，我们只给出一些最容易忽视的错误，希望能作为某种提醒。

如果您实在是需要回顾，请阅读：

- [新加坡国立大学的手册](https://www.comp.nus.edu.sg/~cs2100/lect/MIPS_Reference_Data_page1.pdf)
- [MIPS Quick Tutorial](https://minnie.tuhs.org/CompArch/Resources/mips_quick_tutorial.html)

---

### MIPS程序考察重点

1. 内存访问与数据
2. 内存访问与数据
3. 还是内存访问与数据
4. 地址跳转

是的，程序说到底就是做好一件事：组织好内存中的数据运算。
也就是通过良好的循环结构与运算处理数据。

在这方面，重点考察或需要运用的就是访问数组，用分支指令灵活循环。

堆栈？栈帧？说到底还是内存的处理，每次Caller调用Callee的时候记得保存保留寄存器即可(之后按顺序弹出)。

---

#### 关于MIPS的数组

语法回顾

```mips
.data
    array1: .word 1, 2, 3, 4    # word声明数组中的值，每个占用一个字
    array2: .space 120          # space向内存堆申请120字节的内存
    str: .asciiz "I love Mips"  # asciiz负责存储一个以"\0"结尾的字符串

# 感谢助教提醒
# 按字节存储的字符串最好放到最后，防止打乱字对齐

.eqv i $t0

.text
    # 回顾一些访问数组的方法
    li i, 0
    lw $t1, 0(array1)
    
    la $t2, array2
    lw $t3, 0($t2)

    lw $t4, array2($0)

```

使用数组的语法不难，难的是在一长串莫名其妙的MIPS代码中看出程序意图。在MIPS中那个经典的程序员笑话被发扬到了极致：

>今天我的代码只有上帝和我看得懂，明天，就只有上帝看得懂了。

胡乱写MIPS代码的话，很可能还没写完你和上帝就都看不懂了，综合助教建议和同学经验，我们总结的要点是：

1. 最好多写注释，简单扼要即可
2. 最好先写C或Python实现，逻辑清晰为要
3. 最好统一寄存器使用，重要数据的用保留寄存器，普通数据的用临时寄存器。
4. 别忘了整型字对齐与字符串字节对齐
5. 如果上帝和你真看不懂了，最好给自己的代码画点图……

不必囿于这些要求，此处仅仅以示参考

---

#### 关于MIPS循环的一个发现

助教和学长们的往年精华帖子中提及使用宏来快速编写`for`循环(或者`while`循环，别杠)，然而这里有一个一个问题，**如何实现循环中不同的结束语句判断呢**？例如我想要一个`for(...<=...)`又想要一个`for(...>=...)`，怎么办呢？

答案就是直接写到宏里面，告诉汇编器你想干什么

```mips
.macro for_begin(%cntReg, %conReg, %sLabel, %eLabel, %cmp)

%sLabel:
%cmp, %cntReg, %conReg, %eLabel

.end_macro

# 一个使用示例：
    for_begin($t0, $s0, L_START, L_END, bgt)
    for_end($t0, L_START, L_END)
```

实测可行，宏会被全部替换！

---

#### Visual Studio Code中编写MIPS

如何~~像一个小丑一样地~~在Visual Studio Code中编写MIPS？

先说结论：似乎不太方便，而且没什么好处

MARS不同于我们的ISE Xilinx，不提供关联到外部编辑器的能力。然而，阅读MARS手册中IDE->Editor部分，有这样一段话：

> Editor: MARS includes two integrated text editors. The default editor, ......If you use an external editor, MARS provides a convenience setting that will automatically assemble a file as soon as it is opened. See the Settings menu.

`.asm`文件可以被外部编辑器打开，您只需要手动用外部编辑器（例如）VScode打开当前文件夹编写汇编文件。

~~很明显，如果在VSCode中编写MIPS的话，是不能看到MARS的代码提示的，虽然原本就聊胜于无~~

然而笔者没有找到能够直接在VScode中运行MIPS代码的插件（而且也没有必要），因此之后还需要使用MARS打开该文件并进行`assemble`

- VScode插件：以下是几个提供高亮和简单MIPS代码补全的插件：
- MIPS Assembly Formatter
- MIPS Support
- Better MIPS Support

此外，您可以设置MARS `settings` 中的 `assemble file upon opening` 为 `true` 。这样每次打开文件就会自动汇编。

又或者您可以使用命令行在VScode中运行MARS(这个过程大概可以用一个`shell`脚本简化？)：

```shell
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----        2025/10/22     16:40                conv
d-----        2025/10/22     16:38                full
d-----        2025/10/22     16:37                judge
d-----        2025/10/22     16:40                matrix


PS C:[pwd]> cd conv
PS C:[pwd]> java -jar "C:\Users\Harudog\Desktop\Use\Working Area\Tools\Co\Mars4_5.jar" conv.asm
MARS 4.5  Copyright 2003-2014 Pete Sanderson and Kenneth Vollmar
```

然后您就可以输入样例了

但是还是太繁琐了……
