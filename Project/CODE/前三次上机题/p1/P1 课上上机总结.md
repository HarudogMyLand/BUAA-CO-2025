# P1 课上上机总结

2025.10.21

P1上机考察Verilog HDL的基本使用，组合逻辑与时序电路的相关测试。

### P1_CNNX 异或卷积

一个简单的组合逻辑题，输入位宽36的输入代表 $6\times 6$ 矩阵 $a$ ，和位宽9的输入代表 $3\times 3$ 矩阵 $b$ 作为卷积核，输出卷积后的 $4\times 4$ 矩阵。卷积公式已给出。

考察要点：`for` 循环的使用

反思：

- `for` 循环需要在 `always` 或 `initial` 语句块中使用，并声明循环变量 `integer i, j`；

- `always` 块中连续赋值需要“左值”是 `reg` 类型；

- $0 \oplus x = x $ ，因此需要将左侧变量初始化为 0 即可；

- 卷积的公式可直接用题目给出的
  $$
  ans[i][j] = \oplus^2_{k=0}\oplus^2_{l=0}(a[i+k][j+l]\land b[k][l])
  $$
  计算，然而直接带入容易导致计算错误，建议按题目要求依次计算矩阵。

小小的疑惑：为什么我这样写出错了？

```verilog
// for 循环的声明...
ans[4 * i + j] = ans[4 * i + j] ^ ((a[6*(i+k) + (j+l)] & b[3*k+l]));
```

这样算出来的答案似乎是错的，笔者很明显是小丑🤡

### P1_Note Recorder 音符记录器

一个可记录127个音符的记录器，兼顾时序逻辑和组合逻辑。可以添加音符，查找音符，计算音符频数。

考察要点：简单时序电路，简单组合电路，循环使用，数组与向量

反思：

- 尽管有很多可行的思路，但是使用 `for` 循环似乎仍然是出题者的意图
- 使用数组：`reg [3:0] recorder [127:0];` 使缓冲记录区更加清晰

每个上升沿，根据控制信号进行 `case` 判断：

- `2'b00` 所有音符前移一位。使用 `for` 循环，位拼接（似乎繁琐一点）都是可行的，然后把 `note_in` 拼到 `127` 处；
- `2'b01` 查找 `query` 位的音符；
- `2'b11` 用 `for` 循环判断相等，并记数 `counter` 输出。
- `2'b10` 考虑到 `reg` 自动保存值，不需要其他操作

### P1_JSON

一个简单JSON键值对计数器。统计有效的 `json` 键值对数量，输出上一个 `json` 序列的键值对数量与历史最大值。

#### 输入规律：

虽然严格保证了输入格式，但可能会有的输入陷阱如下：

（注意，下面的`//`表示注释）

```json
{
    "Key": "GUGUGAGA!", // cur_num += 1
    "": "No Keys!", // 导致 cur_num 变为0
    "No Values!":"", // 同上
    // 一堆莫名其妙在各个地方出现的空格
    "Key":"GitImpact" // 实际上没用的键值对
} // 输入大括号的上升沿，输出更新

// 一堆括号

{}// 空空如也的json序列
{
    "Key":"I am value"//正常的Json序列
}// 现在cur_num和max_num都将会是1
```

反思：

- 此题不需要其他特殊的语法回顾，是一道字符状态机题。
- 注意双引号用 ascii 码表示：`char == 8'h22`